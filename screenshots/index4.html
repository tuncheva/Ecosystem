<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Autonomous Ops Agent (Module 6)</title>
  <style>
    :root {
      --bg: #0b0f17;
      --panel: #0f1623;
      --panel2: #0f1623;
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.62);
      --border: rgba(255,255,255,0.10);
      --blue: #3b82f6;
      --shadow: 0 10px 28px rgba(0,0,0,0.45);
      --mono: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, Segoe UI, Arial;
      background: var(--bg);
      color: var(--text);
    }

    .wrap { max-width: 980px; margin: 0 auto; padding: 22px 14px 30px; }

    .header { margin-bottom: 12px; }
    h1 { margin: 0; font-size: 22px; letter-spacing: 0.2px; }

    .subtitle { color: var(--muted); font-size: 13px; margin-top: 6px; }
    .subtitle code {
      font-family: var(--mono);
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.10);
      padding: 3px 8px;
      border-radius: 10px;
      color: rgba(255,255,255,0.88);
    }

    .panel {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 16px;
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .toolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 10px 12px;
      border-bottom: 1px solid var(--border);
      background: var(--panel2);
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(59,130,246,0.32);
      background: rgba(59,130,246,0.10);
      color: rgba(255,255,255,0.92);
      font-size: 12px;
      white-space: nowrap;
    }

    .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--blue);
      box-shadow: 0 0 0 4px rgba(59,130,246,0.15);
    }

    .status {
      color: var(--muted);
      font-size: 12px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 520px;
    }

    .chat {
      padding: 14px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      min-height: 420px;
      max-height: 66vh;
      overflow: auto;
      background: var(--panel);
    }

    .row { display: flex; gap: 10px; align-items: flex-start; }
    .row.user { justify-content: flex-end; }

    .avatar {
      width: 34px;
      height: 34px;
      border-radius: 10px;
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.10);
      display: flex;
      align-items: center;
      justify-content: center;
      color: rgba(255,255,255,0.85);
      font-weight: 800;
      flex: 0 0 auto;
    }

    .bubble {
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.05);
      color: rgba(255,255,255,0.92);
      line-height: 1.35;
      white-space: pre-wrap;
      max-width: 820px;
    }

    .bubble.user {
      background: rgba(59,130,246,0.14);
      border-color: rgba(59,130,246,0.26);
    }

    .bubble.process {
      background: rgba(255,255,255,0.035);
      border-color: rgba(255,255,255,0.10);
      color: rgba(255,255,255,0.80);
      font-family: var(--mono);
      font-size: 12px;
      margin-top: 10px;
    }

    .meta {
      color: rgba(255,255,255,0.55);
      font-size: 11px;
      margin-top: 6px;
    }

    .composer {
      display: flex;
      gap: 10px;
      padding: 12px;
      border-top: 1px solid var(--border);
      background: var(--panel2);
      align-items: center;
    }

    .composer .ghost {
      flex: 1;
      color: rgba(255,255,255,0.55);
      font-size: 12px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.03);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    button {
      appearance: none;
      border: 1px solid rgba(59,130,246,0.55);
      background: rgba(59,130,246,0.95);
      color: white;
      padding: 10px 14px;
      border-radius: 12px;
      font-size: 13px;
      font-weight: 800;
      cursor: pointer;
      box-shadow: 0 10px 18px rgba(59,130,246,0.18);
    }

    button:hover { filter: brightness(1.04); }
    button:disabled { opacity: 0.55; cursor: not-allowed; box-shadow: none; filter: none; }

    .footer {
      display: flex;
      gap: 10px;
      padding: 10px 12px;
      border-top: 1px solid var(--border);
      background: var(--panel2);
      color: var(--muted);
      font-size: 12px;
      flex-wrap: wrap;
    }

    .pill {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.04);
      white-space: nowrap;
    }

    .kbd {
      font-family: var(--mono);
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.04);
      padding: 2px 6px;
      border-radius: 8px;
      color: rgba(255,255,255,0.82);
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <h1>Autonomous Operations Agent</h1>
      <div class="subtitle">Prompt: <code id="promptText">Process new order #XYZ-789.</code></div>
    </div>

    <div class="panel">
      <div class="toolbar">
        <div class="badge"><span class="dot"></span> MCP Host + Tools</div>
        <div id="status" class="status">idle</div>
      </div>

      <div class="chat" id="chat"></div>

      <div class="composer">
        <div class="ghost" id="ghostPrompt">Process new order #XYZ-789.</div>
        <button id="runBtn">Run workflow</button>
      </div>

      <div class="footer">
        <div class="pill">UI: process + final answer</div>
        <div class="pill">Terminal: tool/host logs</div>
        <div class="pill">Status: <span id="uiDiag">ui loaded</span></div>
      </div>
    </div>
  </div>

<script>
  const runBtn = document.getElementById('runBtn');
  const statusEl = document.getElementById('status');
  const uiDiag = document.getElementById('uiDiag');
  const chatEl = document.getElementById('chat');
  const promptTextEl = document.getElementById('promptText');
  const ghostPromptEl = document.getElementById('ghostPrompt');

  const PROMPT = 'Process new order #XYZ-789.';

  function nowIso(tsSeconds) {
    try {
      const ms = (tsSeconds ? (tsSeconds * 1000) : Date.now());
      return new Date(ms).toISOString();
    } catch (_) {
      return '';
    }
  }

  function appendBubble(role, kind, text, ts) {
    if (!chatEl) return null;

    const row = document.createElement('div');
    row.className = 'row' + (role === 'user' ? ' user' : '');

    if (role !== 'user') {
      const av = document.createElement('div');
      av.className = 'avatar';
      av.textContent = 'A';
      row.appendChild(av);
    }

    const bubble = document.createElement('div');
    const isUser = (role === 'user');
    const isProcess = (kind === 'process');
    bubble.className = 'bubble' + (isUser ? ' user' : '') + (isProcess ? ' process' : '');
    bubble.textContent = text || '';

    const meta = document.createElement('div');
    meta.className = 'meta';
    const stamp = nowIso(ts);
    meta.textContent = stamp ? (kind + ' â€¢ ' + stamp) : kind;

    const wrap = document.createElement('div');
    wrap.appendChild(bubble);
    wrap.appendChild(meta);

    row.appendChild(wrap);

    if (isUser) {
      const av = document.createElement('div');
      av.className = 'avatar';
      av.textContent = 'U';
      row.appendChild(av);
    }

    chatEl.appendChild(row);
    chatEl.scrollTop = chatEl.scrollHeight;

    return bubble;
  }

  function setStatus(text) {
    if (statusEl) statusEl.textContent = text;
  }

  function toProcessLine(ev) {
    if (!ev || !ev.type) return '';

    if (ev.type === 'mcp_server_started') {
      const name = String(ev.name || '').toLowerCase();
      if (name.indexOf('crm') >= 0) return 'Connected to CRM system.';
      if (name.indexOf('email') >= 0) return 'Connected to Email system.';
      return 'Connected to tool server: ' + String(ev.name || '');
    }

    if (ev.type === 'gateway_request') {
      return 'Contacting model gateway...';
    }

    if (ev.type === 'assistant') {
      const hasText = (ev.content && String(ev.content).trim());
      if (hasText) return 'Model response received.';
      return 'Planning next action...';
    }

    if (ev.type === 'tool_call') {
      const n = String(ev.name || '');
      if (n.indexOf('getCustomerEmail') >= 0) return 'Looking up customer email for the order...';
      if (n.indexOf('sendShippingConfirmation') >= 0) return 'Sending shipping confirmation email...';
      return 'Calling tool: ' + n;
    }

    if (ev.type === 'stdout') return '';

    return '';
  }

  function initChat() {
    if (!chatEl) return;
    chatEl.textContent = '';
    appendBubble('assistant', 'info', 'Click Run workflow to process the order via MCP.', Date.now()/1000);
  }

  async function startRun() {
    // Only show the user prompt once the workflow starts.
    appendBubble('user', 'user', PROMPT, Date.now()/1000);

    // Assistant answer bubble + process bubble directly under it.
    const answerBubble = appendBubble('assistant', 'answer', 'Working on it...', Date.now()/1000);
    const processBubble = appendBubble('assistant', 'process', 'Process:
- Starting...', Date.now()/1000);

    const processLines = [];

    if (runBtn) runBtn.disabled = true;
    setStatus('starting...');

    const resp = await fetch('/api/runs', { method: 'POST' });
    if (!resp.ok) {
      const txt = await resp.text();
      throw new Error('POST /api/runs failed: ' + resp.status + ' ' + txt);
    }

    const data = await resp.json();
    const runId = data.run_id;
    setStatus('running (' + runId + ')');

    let lastLen = 0;
    const timer = setInterval(async () => {
      try {
        const r = await fetch('/api/runs/' + runId);
        if (!r.ok) {
          const txt = await r.text();
          setStatus('poll failed (' + r.status + ')');
          if (answerBubble) answerBubble.textContent = 'UI polling error.';
          if (processBubble) processBubble.textContent = 'Process:
- [ui] poll error: ' + txt;
          return;
        }

        const s = await r.json();
        setStatus(s.status + (s.error ? ' (error)' : ''));

        const logs = s.logs || [];
        if (logs.length > lastLen) {
          for (let i = lastLen; i < logs.length; i++) {
            const ev = logs[i];
            const line = toProcessLine(ev);
            if (line) {
              if (processLines.length === 0 || processLines[processLines.length - 1] !== line) {
                processLines.push(line);
              }
              if (processBubble) processBubble.textContent = 'Process:
- ' + processLines.join('
- ');
            }

            if (ev && ev.type === 'final') {
              if (answerBubble) answerBubble.textContent = String(ev.content || '');
            }
            if (ev && ev.type === 'error') {
              if (answerBubble) answerBubble.textContent = 'Workflow failed.';
              if (processBubble) processBubble.textContent = 'Process:
- [error] ' + String(ev.error || '');
            }
          }
          lastLen = logs.length;
        }

        if (s.status !== 'running') {
          clearInterval(timer);
          if (runBtn) runBtn.disabled = false;
        }
      } catch (e) {
        setStatus('poll exception');
        appendBubble('assistant', 'error', '[ui] poll exception: ' + String(e), Date.now()/1000);
        if (runBtn) runBtn.disabled = false;
      }
    }, 750);
  }

  if (uiDiag) uiDiag.textContent = 'ui loaded';
  if (promptTextEl) promptTextEl.textContent = PROMPT;
  if (ghostPromptEl) ghostPromptEl.textContent = PROMPT;

  initChat();

  if (runBtn) {
    runBtn.addEventListener('click', () => {
      startRun().catch(err => {
        setStatus('failed to start');
        if (runBtn) runBtn.disabled = false;
        appendBubble('assistant', 'error', '[ui] start error: ' + String(err), Date.now()/1000);
      });
    });
  }
</script>
</body>
</html>